---
apiVersion: canaries.flanksource.com/v1
kind: SystemTemplate
metadata:
  name: elasticsearch
spec:
  type: ElasticSearch
  icon: elastic
  schedule: "@every 10m"
  id:
    javascript: properties.id
  components:
    - name: nodes
      type: ElasticSearchNode
      properties:
        - name: disk-space-total
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_clusters/stats
              transform:
                include: nodes.os.fs.available
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: disk-space-used
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_clusters/stats
              transform:
                include: nodes.os.fs.total
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: version
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_clusters/stats
              transform:
                include: nodes.versions
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: jvm-usage
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_nodes/jvm
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: memory
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_clusters/stats
              transform:
                include: nodes.os.mem.total
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: cores
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_nodes/os
              transform:
                include: os.available_processors
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: load
    - name: index
      type: ElasticSearchIndex
      properties:
        - name: index-metrics
          lookup:
            kubernetes:
              - kind: ElasticMetrics
                ready: false
                name: elasticmetrics
                display:
                  javascript: JSON.stringify(elastic.getIndexMetrics(results))
  properties:
    - name: node-metrics
      lookup:
        kubernetes:
          - kind: ElasticMetrics
            ready: false
            name: elasticmetrics
            display:
              javascript: JSON.stringify(elastic.getNodeMetrics(results))
    - name: total-documents
      http:
        - endpoint: http://elasticsearch-http.default.svc:9200/_stats
          transform:
            include: _all.primaries.docs.count
          authentication:
            username:
              value: elastic
            password:
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-elastic-user
