---
apiVersion: canaries.flanksource.com/v1
kind: SystemTemplate
metadata:
  name: elasticsearch
spec:
  type: ElasticSearch
  icon: elastic
  schedule: "@every 10m"
  id:
    javascript: properties.id
  components:
    - name: nodes
      type: ElasticSearchNode
      properties:
        - name: disk-space-total
          kubernetes:
            - kind: PersistentVolumeClaim
              namespace: default
              selectors:
                matchLabels: common.k8s.elastic.co/type=elasticsearch
              transform:
                include: spec.resources.requests.storage
        - name: disk-space-used
        - name: version
          kubernetes:
            - kind: Pod
              namespace: default
              selectors:
                matchLabels: common.k8s.elastic.co/type=elasticsearch
              transform:
                include: metadata.labels.elasticsearch\.k8s\.elastic\.co/version
        - name: jvm-usage
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_nodes/jvm
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: memory
          kubernetes:
            - kind: PodMetrics
              namespace: default
              selectors:
                matchLabels: common.k8s.elastic.co/type=elasticsearch
              transform:
                include: containers[0].usage.memory
        - name: cores
          kubernetes:
            - kind: PodMetrics
              namespace: default
              selectors:
                matchLabels: common.k8s.elastic.co/type=elasticsearch
              transform:
                include: containers[0].usage.cpu
        - name: load
    - name: index
      type: ElasticSearchIndex
      properties:
        - name: name
        - name: documents
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_stats
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: size
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_stats
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: healthy-indices
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_stats
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
        - name: unhealthy-indices
          http:
            - endpoint: http://elasticsearch-http.default.svc:9200/_stats
              authentication:
                username:
                  value: elastic
                password:
                  valueFrom:
                    secretKeyRef:
                      name: elasticsearch-elastic-user
  properties:
    - name: version
      kubernetes:
        - kind: ElasticSearch
          namespace: default
          transform:
            include: spec.version
    - name: disk-space-used
    - name: disk-space-free-min
    - name: total-documents
